generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String       @id @default(uuid())
  username     String       @unique
  passwordHash String
  role         UserRole
  isWaliKelas  Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?
  admin        Admin?
  dokumens     Dokumen[]
  guru         Guru?
  Pengumuman   Pengumuman[]
  siswa        Siswa?
}

model Admin {
  id              String           @id @default(uuid())
  userId          String           @unique
  nama            String
  email           String?          @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?
  user            User             @relation(fields: [userId], references: [id])
  MataPelajaran   MataPelajaran[]
  Ruangan         Ruangan[]
  SekolahData     SekolahData[]
  skemaPenilaians SkemaPenilaian[]
  TahunAjaran     TahunAjaran[]
  TingkatanKelas  TingkatanKelas[]
}

model Guru {
  id                String              @id @default(uuid())
  userId            String              @unique
  nip               String?             @unique
  nama              String
  email             String?             @unique
  jenisKelamin      String?
  agama             String?
  tempatLahir       String?
  tanggalLahir      DateTime?
  noTelp            String?
  nik               String?
  nuptk             String?
  statusKepegawaian String?
  alamat            String?
  isAktif           Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  deletedAt         DateTime?
  AbsensiSesi       AbsensiSesi[]
  CapaianInput      CapaianKompetensi[]
  user              User                @relation(fields: [userId], references: [id])
  Jadwal            Jadwal[]
  KelasBimbingan    Kelas?
  NilaiInput        NilaiDetailSiswa[]
  Penugasan         PenugasanGuru[]
  RaporDiurus       Rapor[]
}

model Siswa {
  id                   String              @id @default(uuid())
  userId               String              @unique
  nisn                 String              @unique
  nama                 String
  jenisKelamin         String?
  agama                String?
  tempatLahir          String?
  tanggalLahir         DateTime?
  pendidikanSebelumnya String?
  alamat               String?
  namaAyah             String?
  pekerjaanAyah        String?
  namaIbu              String?
  pekerjaanIbu         String?
  alamatOrtu           String?
  namaWali             String?
  pekerjaanWali        String?
  alamatWali           String?
  status               String?             @default("Aktif")
  nik                  String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  deletedAt            DateTime?
  AbsensiDetail        AbsensiDetail[]
  CapaianDiperoleh     CapaianKompetensi[]
  NilaiDiperoleh       NilaiDetailSiswa[]
  Penempatan           PenempatanSiswa[]
  Rapor                Rapor[]
  user                 User                @relation(fields: [userId], references: [id])

  @@index([status])
}

model SekolahData {
  id            String    @id @default(uuid())
  adminId       String
  namaSekolah   String
  alamat        String?
  kepalaSekolah String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  admin         Admin     @relation(fields: [adminId], references: [id])
}

model TahunAjaran {
  id         String            @id @default(uuid())
  adminId    String
  nama       String            @unique
  isAktif    Boolean           @default(false)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deletedAt  DateTime?
  Jadwal     Jadwal[]
  Penempatan PenempatanSiswa[]
  rapors     Rapor[]
  admin      Admin             @relation(fields: [adminId], references: [id])
}

model TingkatanKelas {
  id          String    @id @default(uuid())
  adminId     String
  namaTingkat String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  Kelas       Kelas[]
  admin       Admin     @relation(fields: [adminId], references: [id])
}

model Ruangan {
  id          String    @id @default(uuid())
  adminId     String
  namaRuangan String    @unique
  kapasitas   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  Jadwal      Jadwal[]
  admin       Admin     @relation(fields: [adminId], references: [id])
}

model Kelas {
  id             String            @id @default(uuid())
  namaKelas      String
  tingkatanId    String
  waliKelasId    String?           @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime?
  absensiSesis   AbsensiSesi[]
  Jadwal         Jadwal[]
  tingkatan      TingkatanKelas    @relation(fields: [tingkatanId], references: [id])
  waliKelas      Guru?             @relation(fields: [waliKelasId], references: [id])
  Penempatan     PenempatanSiswa[]
  penugasanGurus PenugasanGuru[]
  rapors         Rapor[]
}

model PenempatanSiswa {
  id            String      @id @default(uuid())
  siswaId       String
  kelasId       String
  tahunAjaranId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?
  kelas         Kelas       @relation(fields: [kelasId], references: [id])
  siswa         Siswa       @relation(fields: [siswaId], references: [id])
  tahunAjaran   TahunAjaran @relation(fields: [tahunAjaranId], references: [id])

  @@unique([siswaId, tahunAjaranId])
}

model MataPelajaran {
  id                 String              @id @default(uuid())
  adminId            String
  namaMapel          String
  kategori           MapelCategory
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  capaianKompetensis CapaianKompetensi[]
  jadwals            Jadwal[]
  admin              Admin               @relation(fields: [adminId], references: [id])
  nilaiDetailSiswas  NilaiDetailSiswa[]
  nilaiRaporAkhirs   NilaiRaporAkhir[]
  Penugasan          PenugasanGuru[]
  SkemaPenilaian     SkemaPenilaian?
}

model PenugasanGuru {
  id        String        @id @default(uuid())
  guruId    String
  mapelId   String
  kelasId   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?
  guru      Guru          @relation(fields: [guruId], references: [id])
  kelas     Kelas         @relation(fields: [kelasId], references: [id])
  mapel     MataPelajaran @relation(fields: [mapelId], references: [id])

  @@unique([guruId, mapelId, kelasId])
}

model SkemaPenilaian {
  id        String          @id @default(uuid())
  adminId   String
  mapelId   String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?
  Komponen  NilaiKomponen[]
  admin     Admin           @relation(fields: [adminId], references: [id])
  mapel     MataPelajaran   @relation(fields: [mapelId], references: [id])
}

model NilaiKomponen {
  id           String             @id @default(uuid())
  skemaId      String
  namaKomponen String
  tipe         NilaiKomponenType
  formula      String?
  urutan       Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  deletedAt    DateTime?
  NilaiDetail  NilaiDetailSiswa[]
  skema        SkemaPenilaian     @relation(fields: [skemaId], references: [id])
}

model Jadwal {
  id            String        @id @default(uuid())
  tahunAjaranId String
  kelasId       String
  mapelId       String
  guruId        String
  ruanganId     String
  hari          String
  waktuMulai    String
  waktuSelesai  String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
  guru          Guru          @relation(fields: [guruId], references: [id])
  kelas         Kelas         @relation(fields: [kelasId], references: [id])
  mapel         MataPelajaran @relation(fields: [mapelId], references: [id])
  ruangan       Ruangan       @relation(fields: [ruanganId], references: [id])
  tahunAjaran   TahunAjaran   @relation(fields: [tahunAjaranId], references: [id])

  @@index([hari])
}

model AbsensiSesi {
  id          String          @id @default(uuid())
  guruId      String
  kelasId     String
  tanggal     DateTime
  pertemuanKe Int
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
  Detail      AbsensiDetail[]
  guru        Guru            @relation(fields: [guruId], references: [id])
  kelas       Kelas           @relation(fields: [kelasId], references: [id])

  @@unique([kelasId, tanggal, pertemuanKe])
}

model AbsensiDetail {
  id        String        @id @default(uuid())
  siswaId   String
  sesiId    String
  status    AbsensiStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?
  sesi      AbsensiSesi   @relation(fields: [sesiId], references: [id])
  siswa     Siswa         @relation(fields: [siswaId], references: [id])

  @@unique([siswaId, sesiId])
}

model NilaiDetailSiswa {
  id             String         @id @default(uuid())
  siswaId        String
  mapelId        String
  komponenId     String?
  guruId         String
  nilaiAngka     Float?
  nilaiDeskripsi String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  guru           Guru           @relation(fields: [guruId], references: [id])
  komponen       NilaiKomponen? @relation(fields: [komponenId], references: [id])
  mapel          MataPelajaran  @relation(fields: [mapelId], references: [id])
  siswa          Siswa          @relation(fields: [siswaId], references: [id])

  @@unique([siswaId, mapelId, komponenId])
}

model CapaianKompetensi {
  id        String        @id @default(uuid())
  siswaId   String
  mapelId   String
  guruId    String
  deskripsi String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?
  guru      Guru          @relation(fields: [guruId], references: [id])
  mapel     MataPelajaran @relation(fields: [mapelId], references: [id])
  siswa     Siswa         @relation(fields: [siswaId], references: [id])

  @@unique([siswaId, mapelId])
}

model Rapor {
  id               String            @id @default(uuid())
  siswaId          String
  kelasId          String
  tahunAjaranId    String
  waliKelasId      String
  catatanWaliKelas String?
  dataKokurikuler  String?
  isFinalisasi     Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  NilaiRaporAkhir  NilaiRaporAkhir[]
  kelas            Kelas             @relation(fields: [kelasId], references: [id])
  siswa            Siswa             @relation(fields: [siswaId], references: [id])
  tahunAjaran      TahunAjaran       @relation(fields: [tahunAjaranId], references: [id])
  waliKelas        Guru              @relation(fields: [waliKelasId], references: [id])

  @@unique([siswaId, tahunAjaranId])
}

model NilaiRaporAkhir {
  id         String        @id @default(uuid())
  raporId    String
  mapelId    String
  nilaiAkhir Float?
  isOverride Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  deletedAt  DateTime?
  mapel      MataPelajaran @relation(fields: [mapelId], references: [id])
  rapor      Rapor         @relation(fields: [raporId], references: [id])

  @@unique([raporId, mapelId])
}

model Dokumen {
  id        String    @id @default(uuid())
  adminId   String
  judul     String
  urlFile   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  admin     User      @relation(fields: [adminId], references: [id])
}

model Pengumuman {
  id               String    @id @default(uuid())
  adminId          String
  judul            String
  konten           String
  target           String    @default("SEMUA")
  tanggalPublikasi DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  admin            User      @relation(fields: [adminId], references: [id])
}

enum UserRole {
  ADMIN
  GURU
  SISWA
}

enum MapelCategory {
  WAJIB
  MUATAN_LOKAL
  EKSTRAKURIKULER
}

enum NilaiKomponenType {
  INPUT
  READ_ONLY
}

enum AbsensiStatus {
  HADIR
  SAKIT
  IZIN
  ALPHA
}
